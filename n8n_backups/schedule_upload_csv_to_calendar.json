{
  "name": "schedule_upload_csv_to_calendar",
  "nodes": [
    {
      "parameters": {
        "content": "## Phase 1\nThe academic personnel uploads the csv file containing a comprehensive schedule; the worlflow aims to convert them into multiple GCalendar Upload Schedules",
        "width": 288
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -960,
        -416
      ],
      "id": "b54625fc-0ec2-4ca7-a253-e1b2c5f2440c",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### Expected CSV columns\nEvent_Title\tEvent_Date\tLocation\tStart_Time\tNotify_Rule\tChannels\tTarget_Audience\tDept_Filter\tContent_Remarks\tAssets_URL",
        "width": 288,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -656,
        -416
      ],
      "id": "aca64ad5-0363-44fd-83e4-0e33677770c4",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "import-schedule",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -960,
        -192
      ],
      "id": "e48835f1-11f3-4073-8afb-f222cdfaa2a9",
      "name": "Webhook",
      "webhookId": "8ec3e740-160c-41f7-8c01-a549a1d28bc6"
    },
    {
      "parameters": {
        "options": {
          "headerRow": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -752,
        -192
      ],
      "id": "6b633815-d6d8-45a4-96d1-9092c52fd94e",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const row = item.json;\n\n  // --- 1. Parse Date (Standard JS) ---\n  // new Date() handles both \"2025-12-12\" and \"12/22/2025\" automatically in Node.js\n  let eventDate = new Date(row.Event_Date);\n\n  // Fallback validation: if date is \"Invalid Date\", try to fix or default\n  if (isNaN(eventDate.getTime())) {\n      throw new Error(`Invalid Date format in row: ${row.Event_Title}`);\n  }\n\n  // --- 2. Set Start Time ---\n  const timeParts = (row.Start_Time || \"09:00\").split(':');\n  eventDate.setHours(parseInt(timeParts[0]), parseInt(timeParts[1] || 0), 0, 0);\n\n  // --- 3. Calculate Trigger Date (The Math) ---\n  // We clone the date so we don't mess up the original event time\n  let triggerDate = new Date(eventDate);\n  const rule = (row.Notify_Rule || \"\").toLowerCase();\n\n  if (rule.includes(\"week\")) {\n    const match = rule.match(/(\\d+)\\s*week/);\n    const weeks = match ? parseInt(match[1]) : 1;\n    const daysToShift = weeks * 7;\n\n    if (rule.includes(\"before\")) {\n        triggerDate.setDate(triggerDate.getDate() - daysToShift);\n    } else if (rule.includes(\"after\")) {\n        triggerDate.setDate(triggerDate.getDate() + daysToShift);\n    }\n\n  } else if (rule.includes(\"day\")) {\n    const match = rule.match(/(\\d+)\\s*day/);\n    const days = match ? parseInt(match[1]) : 1;\n\n    if (rule.includes(\"before\")) {\n        triggerDate.setDate(triggerDate.getDate() - days);\n    }\n    // \"after\" logic can be added similarly if needed\n  } \n  // \"Same day\" does nothing, so triggerDate stays equal to eventDate\n\n  // --- 4. Formatting for Output (ISO Strings) ---\n  // Helper to get ISO string without milliseconds for cleaner GCal input\n  const toISO = (d) => d.toISOString().split('.')[0] + \"Z\";\n  \n  // Calculate End Time (Start + 1 Hour)\n  let endDate = new Date(eventDate);\n  endDate.setHours(endDate.getHours() + 1);\n\n  return {\n    json: {\n      // VISUAL: Calendar Event\n      gcal_start: eventDate.toISOString(),\n      gcal_end: endDate.toISOString(),\n      \n      event_title: row.Event_Title,\n      location: row.Location || \"TBD\",\n\n      // LOGIC: Hidden Metadata\n      description_payload: JSON.stringify({\n        cms_data: {\n            title: row.Event_Title,\n            remarks: row.Content_Remarks,\n            audience: row.Target_Audience\n        },\n        automation_trigger: {\n            // We strip the time for the trigger date check (YYYY-MM-DD)\n            trigger_date: triggerDate.toISOString().split('T')[0], \n            original_rule: row.Notify_Rule\n        }\n      }, null, 2)\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        -192
      ],
      "id": "1651095f-7468-4793-883c-09d08d7886d7",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "content": "output: json\n\ntarget: student, parents, public\n\nplatoform: email, website\n\nenglish body:\n\nvietnamese body:\n\nlocation"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -512,
        256
      ],
      "id": "5ca2f1db-287d-441f-86f7-3e4d1106a222",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "add own spec"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        128,
        192
      ],
      "id": "085c6e8e-9490-4bb6-b212-f947ee80abc1",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -336,
        -192
      ],
      "id": "b74ac955-d45c-427b-b16e-5d053efb1e46",
      "name": "Create an event",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "k7pbgrJsa2giYhfg",
          "name": "Google Calendar account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Create an event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "05c15cd1-6f8f-4f8c-8853-c477795939b5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bb709ae20030df1c4b0f5759637f85677b8df22906d0836a494313e61c4dc3ca"
  },
  "id": "BAOLmybiMN7Qakbx",
  "tags": []
}